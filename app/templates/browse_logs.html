{% extends "base.html" %}
{% block title %}浏览记录 - CPIMS{% endblock %}

{% block content %}
<div class="header">
    <div class="header-title">
        <h1>浏览记录</h1>
        <p>用户浏览行为数据</p>
    </div>
</div>

<div class="content">
    <div class="card mb-4">
        <div class="card-body py-3">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-control" name="username" value="{{ username }}" placeholder="搜索用户...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">开始日期</label>
                    <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">结束日期</label>
                    <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">查询</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <span><i class="bi bi-list-check"></i>浏览明细</span>
            <span class="badge badge-default">{{ total_count }} 条</span>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户</th>
                        <th>商品</th>
                        <th>浏览时间</th>
                        <th>渠道</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td style="color: var(--text-muted);">#{{ log.id }}</td>
                        <td>{{ log.user.username }}</td>
                        <td style="color: var(--text); font-weight: 500;">{{ log.product.name }}</td>
                        <td style="color: var(--text-muted);">{{ log.browse_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if log.platform == 'PC' %}<span class="badge badge-default">PC</span>
                            {% elif log.platform == 'APP' %}<span class="badge badge-primary">APP</span>
                            {% else %}<span class="badge badge-success">{{ log.platform }}</span>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if pagination.pages > 1 %}
        <div class="pagination-wrap">
            <nav><ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.browse_logs', page=pagination.prev_num, username=username, start_date=start_date, end_date=end_date) }}">上一页</a>
                </li>
                {% for p in pagination.iter_pages() %}
                    {% if p %}<li class="page-item {% if p == pagination.page %}active{% endif %}"><a class="page-link" href="{{ url_for('main.browse_logs', page=p, username=username, start_date=start_date, end_date=end_date) }}">{{ p }}</a></li>
                    {% else %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.browse_logs', page=pagination.next_num, username=username, start_date=start_date, end_date=end_date) }}">下一页</a>
                </li>
            </ul></nav>
            <div class="page-jump">
                <span>跳至</span>
                <input type="number" id="pageInput" min="1" max="{{ pagination.pages }}" value="{{ pagination.page }}">
                <span>/ {{ pagination.pages }} 页</span>
                <button onclick="jumpToPage()">跳转</button>
            </div>
        </div>
        <script>
        function jumpToPage() {
            var page = parseInt(document.getElementById('pageInput').value);
            var maxPage = {{ pagination.pages }};
            if (page >= 1 && page <= maxPage) {
                var url = '{{ url_for("main.browse_logs") }}?page=' + page;
                var username = '{{ username }}';
                var startDate = '{{ start_date }}';
                var endDate = '{{ end_date }}';
                if (username) url += '&username=' + encodeURIComponent(username);
                if (startDate) url += '&start_date=' + startDate;
                if (endDate) url += '&end_date=' + endDate;
                window.location.href = url;
            }
        }
        document.getElementById('pageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') jumpToPage();
        });
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}
