{% extends "base.html" %}

{% block title %}数据概览 - CPIMS{% endblock %}

{% block content %}
<div class="top-header">
    <div class="page-title-section">
        <h1>数据概览</h1>
        <p>实时监控业务数据与运营指标</p>
    </div>
    <div class="header-actions">
        <span class="text-muted" style="font-size: 0.875rem;">
            <i class="bi bi-calendar3 me-1"></i> {{ now().strftime('%Y年%m月%d日') if now is defined else '2025年' }}
        </span>
    </div>
</div>

<div class="content-area">
    <!-- 核心指标 -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(34,197,94,0.1); color: var(--success);">
                    <i class="bi bi-currency-yen"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">年度销售额</div>
                    <div class="stat-value">¥{{ total_sales }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(14,165,233,0.1); color: var(--secondary);">
                    <i class="bi bi-bag-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">销售数量</div>
                    <div class="stat-value">{{ total_qty }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(79,70,229,0.1); color: var(--primary);">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">商品总数</div>
                    <div class="stat-value">{{ total_products }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(245,158,11,0.1); color: var(--warning);">
                    <i class="bi bi-people"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">注册用户</div>
                    <div class="stat-value">{{ total_users }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> 月度销售趋势
                </div>
                <div class="card-body">
                    <div class="chart-container-lg">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-pie-chart"></i> 品类分布
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-bar-chart"></i> 每日浏览量
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="browseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-trophy"></i> 热销商品 TOP10
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据洞察 & 预警 -->
    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-lightbulb"></i> 数据洞察
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <div class="text-center p-3" style="background: var(--gray-50); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                                    ¥{{ "%.0f"|format(total_sales|replace(',','')|float / total_qty if total_qty > 0 else 0) }}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">平均客单价</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="text-center p-3" style="background: var(--gray-50); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">
                                    {{ "%.1f"|format(total_qty / total_users if total_users > 0 else 0) }}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">人均购买量</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="text-center p-3" style="background: var(--gray-50); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">
                                    {{ "%.1f"|format((total_qty / (chart_counts|sum if chart_counts|sum > 0 else 1)) * 100) }}%
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">浏览转化率</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="text-center p-3" style="background: var(--gray-50); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">
                                    {{ "%.1f"|format(total_qty / total_products if total_products > 0 else 0) }}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">商品周转率</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-device-hdd"></i> 访问渠道
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="platformChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if low_stock_count > 0 %}
    <div class="alert mt-4" style="background: rgba(245,158,11,0.1); border-left: 4px solid var(--warning);">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill text-warning me-3" style="font-size: 1.5rem;"></i>
            <div class="flex-grow-1">
                <strong>库存预警</strong>
                <p class="mb-0 mt-1" style="color: var(--gray-600);">有 {{ low_stock_count }} 个商品库存低于10件，建议及时补货</p>
            </div>
            <a href="{{ url_for('main.products_manage') }}" class="btn btn-warning btn-sm">查看详情</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
Chart.defaults.font.family = 'Inter, sans-serif';
Chart.defaults.font.size = 12;
Chart.defaults.color = '#6b7280';

const colors = {
    primary: '#4f46e5',
    secondary: '#0ea5e9',
    success: '#22c55e',
    warning: '#f59e0b',
    danger: '#ef4444',
    purple: '#8b5cf6',
    pink: '#ec4899',
    cyan: '#06b6d4'
};

// 月度销售趋势
new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
        labels: {{ month_labels | tojson }},
        datasets: [{
            label: '销售额',
            data: {{ month_amounts | tojson }},
            borderColor: colors.primary,
            backgroundColor: 'rgba(79, 70, 229, 0.05)',
            borderWidth: 2,
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#fff',
            pointBorderWidth: 2,
            yAxisID: 'y'
        }, {
            label: '销量',
            data: {{ month_quantities | tojson }},
            borderColor: colors.success,
            backgroundColor: 'transparent',
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#fff',
            pointBorderWidth: 2,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: { legend: { position: 'top', align: 'end' } },
        scales: {
            y: { position: 'left', beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: v => '¥' + v.toLocaleString() } },
            y1: { position: 'right', beginAtZero: true, grid: { display: false } },
            x: { grid: { display: false } }
        }
    }
});

// 品类分布
new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
        labels: {{ category_labels | tojson }},
        datasets: [{
            data: {{ category_amounts | tojson }},
            backgroundColor: [colors.primary, colors.secondary, colors.success, colors.warning, colors.purple, colors.pink, colors.cyan, colors.danger],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: { legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true } } }
    }
});

// 每日浏览
new Chart(document.getElementById('browseChart'), {
    type: 'bar',
    data: {
        labels: {{ chart_dates | tojson }},
        datasets: [{
            label: '浏览量',
            data: {{ chart_counts | tojson }},
            backgroundColor: colors.secondary,
            borderRadius: 4,
            barThickness: 16
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
            x: { grid: { display: false }, ticks: { maxRotation: 45 } }
        }
    }
});

// 热销商品
new Chart(document.getElementById('topProductsChart'), {
    type: 'bar',
    data: {
        labels: {{ top_product_names | tojson }},
        datasets: [{
            label: '销量',
            data: {{ top_product_sales | tojson }},
            backgroundColor: colors.primary,
            borderRadius: 4,
            barThickness: 18
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: {
            x: { beginAtZero: true, grid: { color: '#f3f4f6' } },
            y: { grid: { display: false } }
        }
    }
});

// 访问渠道
new Chart(document.getElementById('platformChart'), {
    type: 'doughnut',
    data: {
        labels: {{ platform_labels | tojson }},
        datasets: [{
            data: {{ platform_counts | tojson }},
            backgroundColor: [colors.primary, colors.secondary, colors.success, colors.warning],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { position: 'right', labels: { padding: 8, usePointStyle: true, font: { size: 11 } } } }
    }
});
</script>
{% endblock %}
