{% extends "base.html" %}
{% block title %}销售记录 - CPIMS{% endblock %}

{% block content %}
<div class="header">
    <div class="header-title">
        <h1>销售记录</h1>
        <p>查询销售数据</p>
    </div>
</div>

<div class="content">
    <div class="card mb-4">
        <div class="card-body py-3">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-9">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" name="param_keyword" value="{{ keyword }}" placeholder="搜索商品名称...">
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">查询</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">订单数</div>
                <div class="metric-value">{{ total_count }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">销售总额</div>
                <div class="metric-value success">¥{{ "%.0f"|format(total_amount) }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">商品数量</div>
                <div class="metric-value">{{ total_qty }}</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <span><i class="bi bi-table"></i>销售明细</span>
            <span class="badge badge-default">{{ pagination.total }} 条</span>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>订单号</th>
                        <th>商品</th>
                        <th>用户</th>
                        <th>日期</th>
                        <th>单价</th>
                        <th>数量</th>
                        <th>金额</th>
                        <th>支付方式</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in sales %}
                    <tr>
                        <td style="color: var(--text-muted);">#{{ s.id }}</td>
                        <td style="color: var(--text); font-weight: 500;">{{ s.product.name }}</td>
                        <td>{{ s.user.username }}</td>
                        <td style="color: var(--text-muted);">{{ s.sale_date.strftime('%Y-%m-%d') }}</td>
                        <td>¥{{ "%.2f"|format(s.unit_price) }}</td>
                        <td><span class="badge badge-default">{{ s.quantity }}</span></td>
                        <td style="color: var(--success); font-weight: 600;">¥{{ "%.2f"|format(s.total_amount) }}</td>
                        <td><span class="badge badge-primary">{{ s.payment_method }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if pagination.pages > 1 %}
        <div class="card-body border-top">
            <nav><ul class="pagination pagination-sm mb-0 justify-content-center">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.sales_query', page=pagination.prev_num, param_keyword=keyword) }}">上一页</a>
                </li>
                {% for p in pagination.iter_pages() %}
                    {% if p %}<li class="page-item {% if p == pagination.page %}active{% endif %}"><a class="page-link" href="{{ url_for('main.sales_query', page=p, param_keyword=keyword) }}">{{ p }}</a></li>
                    {% else %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.sales_query', page=pagination.next_num, param_keyword=keyword) }}">下一页</a>
                </li>
            </ul></nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
